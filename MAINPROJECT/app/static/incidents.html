<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>История инцидентов - PingTower</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="card header-card">
        <div class="header-wrapper">
            <div class="tower-icon">
                <img src="/static/images/cell-tower.png" alt="Вышка">
                <span class="signal-dot"></span>
            </div>
            <h1>
                <span class="ping">Ping</span>
                <span class="tower">Tower</span>
            </h1>
        </div>
    </header>

    <!-- Тумблер темы в правом верхнем углу -->
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider"></div>
        </label>
        <span class="slider-label">Сменить тему</span>
    </div>

    <div id="notification" class="notification hidden"></div>

    <main class="incidents-page card">
        <!-- Добавляем кнопку "Назад" -->
        <div class="incidents-header">
            <button class="back-button" onclick="window.location.href='/'">← Назад к сервисам</button>
            <h1>История инцидентов</h1>
            <p>Полный журнал событий по всем отслеживаемым сервисам.</p>
        </div>

        <div class="filter-controls">
            <div class="filter-group">
                <span class="filter-label">Фильтр по статусу:</span>
                <select id="incidentStatusFilter" class="filter-select">
                    <option value="all">Все</option>
                    <option value="resolved">Завершенные</option>
                    <option value="ongoing">Текущие</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Поиск по сервису:</span>
                <input type="text" id="incidentSearchInput" class="search-input" placeholder="Название сервиса...">
            </div>
        </div>

        <table class="incidents-table">
            <thead>
                <tr>
                    <th>Сервис</th>
                    <th>Начало</th>
                    <th>Конец</th>
                    <th>Длительность</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="incidentsList">
                <tr>
                    <td colspan="5" style="text-align: center;">Загрузка инцидентов...</td>
                </tr>
            </tbody>
        </table>

        <div class="pagination">
            <button id="prevPage" disabled>Назад</button>
            <span class="pagination-info">Страница <span id="currentPage">1</span> из <span id="totalPages">1</span></span>
            <button id="nextPage">Вперед</button>
        </div>
    </main>

    <!-- Скрипт для переключения тем -->
    <script>
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.documentElement.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'light') {
                toggleSwitch.checked = true;
            }
        }

        function switchTheme(e) {
            if (e.target.checked) {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        toggleSwitch.addEventListener('change', switchTheme, false);
    </script>

    <!-- Основной JS для страницы инцидентов -->
    <script>
        const API_BASE = '';
        const incidentsList = document.getElementById('incidentsList');
        const statusFilter = document.getElementById('incidentStatusFilter');
        const searchInput = document.getElementById('incidentSearchInput');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const currentPageSpan = document.getElementById('currentPage');
        const totalPagesSpan = document.getElementById('totalPages');

        let allIncidents = [];
        let filteredIncidents = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        function formatDate(isoString) {
            if (!isoString) return '—';
            return new Date(isoString).toLocaleString();
        }

        function formatDuration(start, end) {
            if (!start) return '—';
            const startDate = new Date(start);
            const endDate = end ? new Date(end) : new Date();
            const diffMs = endDate - startDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHrs = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHrs / 24);

            if (diffDays > 0) {
                return `${diffDays}д ${diffHrs % 24}ч ${diffMins % 60}м`;
            } else if (diffHrs > 0) {
                return `${diffHrs}ч ${diffMins % 60}м`;
            } else {
                return `${diffMins}м`;
            }
        }

        function getStatusElement(isOngoing) {
            const statusClass = isOngoing ? 'ongoing' : 'resolved';
            const statusText = isOngoing ? 'Текущий' : 'Завершен';
            const span = document.createElement('span');
            span.className = `incident-status ${statusClass}`;
            span.textContent = statusText;
            return span;
        }

        function renderIncidents() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageIncidents = filteredIncidents.slice(startIndex, endIndex);

            incidentsList.innerHTML = '';

            if (pageIncidents.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.textContent = 'Инциденты не найдены.';
                cell.style.textAlign = 'center';
                row.appendChild(cell);
                incidentsList.appendChild(row);
                return;
            }

            pageIncidents.forEach(incident => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${incident.service_name || 'Неизвестный сервис'}</td>
                    <td>${formatDate(incident.start)}</td>
                    <td>${incident.end ? formatDate(incident.end) : '—'}</td>
                    <td>${formatDuration(incident.start, incident.end)}</td>
                    <td></td>
                `;
                const statusCell = row.querySelector('td:last-child');
                statusCell.appendChild(getStatusElement(!incident.end));
                incidentsList.appendChild(row);
            });

            // Обновить пагинацию
            const totalPages = Math.ceil(filteredIncidents.length / itemsPerPage);
            totalPagesSpan.textContent = totalPages || 1;
            currentPageSpan.textContent = currentPage;

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        function filterIncidents() {
            const statusValue = statusFilter.value;
            const searchTerm = searchInput.value.toLowerCase();

            filteredIncidents = allIncidents.filter(incident => {
                const matchesStatus = statusValue === 'all' ||
                    (statusValue === 'resolved' && incident.end) ||
                    (statusValue === 'ongoing' && !incident.end);

                const matchesSearch = searchTerm === '' ||
                    (incident.service_name && incident.service_name.toLowerCase().includes(searchTerm));

                return matchesStatus && matchesSearch;
            });

            currentPage = 1; // Сброс на первую страницу при фильтрации
            renderIncidents();
        }

        async function fetchIncidents() {
            try {
                const response = await fetch(`${API_BASE}/incidents`);
                if (!response.ok) throw new Error('Ошибка загрузки инцидентов');
                allIncidents = await response.json();
                // Сортируем по дате начала (новые первые)
                allIncidents.sort((a, b) => new Date(b.start) - new Date(a.start));
                filteredIncidents = [...allIncidents];
                renderIncidents();
            } catch (err) {
                console.error('Ошибка при загрузке инцидентов:', err);
                incidentsList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f44336;">Ошибка загрузки инцидентов.</td></tr>';
            }
        }

        // События
        statusFilter.addEventListener('change', filterIncidents);
        searchInput.addEventListener('input', filterIncidents);

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderIncidents();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredIncidents.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderIncidents();
            }
        });

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            fetchIncidents();
        });
    </script>
</body>
</html>